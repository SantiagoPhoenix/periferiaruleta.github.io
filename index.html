<!DOCTYPE html>
<html>
<head>
	<title>Sorteo</title>
	<link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
	<div class="header">
  <img src="periferia.png" alt="Logo de la empresa">
</div>
	<div class="contenedor">
		<h1 id="title">Concursantes</h1>
		<div class="concursantes">
			<canvas id="idcanvas" width="600" height="600"></canvas>
			<br>
			<button id="botonSortear"onclick="sortear()"><span id="idestado">Sortear</span></button>
			<!-- <div class="mark-winner"></div> -->
		</div>
	</div>
	<div class="contenedor-tabla">
		<h2>Ganadores</h2>
		<table id="table">
			<tbody id="tbody"></tbody>
		</table>
	</div>
	<script type="text/javascript">
		const array_ganadores = [];
		var ganadoresEliminar = []
		var indice = 0; 
    var intervalID; 
		var boton; 

		const array_concursantes = [];
 
cargarConcursantes();

 function cargarConcursantes() {
	console.log("inicia");
	fetch('https://santiagophoenix.github.io/periferiaruleta.github.io/participantes-andicom.json')
            .then(response => response.json()) // Parseamos la respuesta a JSON
            .then(data => {
                console.log("carga concursantes" + data.length);
								array_concursantes = data;
            })
            .catch(error => {
                console.error('Hubo un error al cargar el JSON:', error);
  });
 }

function eliminarGanadores(ganadores) {
		ganadores.forEach(e => array_concursantes.splice(e, 1));
		ganadoresEliminar = [];
	}

	const escogerGanadores = () => {
			setTimeout(() => {
				const winner = array_concursantes.find(e => e.ganador === 1);
				const indexGanador = array_concursantes.findIndex((e) => e.nombre === winner.nombre);
					if(winner.ganador === 1) {
						console.log(winner);
						array_ganadores.push(winner)
						ganadoresEliminar.push(indexGanador);
						agregarFila(winner);
					};
				
			}, 5000);
		}

		
			function agregarFila(winner) {
			var tabla = document.getElementById("table"); 
			var fila = tabla.insertRow();
			var celda = fila.insertCell(); 
			celda.textContent = `${array_ganadores.length } - ${String(winner.nombre).toUpperCase()}`; 
			if(array_ganadores.length < 9){
				boton.style.display = '';
			}
			clearInterval(movement);
			clearInterval(intervalID);
			actualizarH1ConTexto(winner);
			clearTimeout(escogerGanadores);
			clic=0;
			document.getElementById("idestado").innerHTML="Sortear";
		}
		
		let canvas=document.getElementById("idcanvas");
		let context=canvas.getContext("2d");
		let center=canvas.width/2;

		context.beginPath();
		context.moveTo(center,center);
		context.arc(center,center,center,0, 2*Math.PI);
		context.lineTo(center,center);
		context.fillStyle ='#33333333';
		context.fill();

		context.beginPath();
		context.moveTo(center,center);
		context.arc(center,center,center-10,0, 2*Math.PI);
		context.lineTo(center,center);
		context.fillStyle ='black';
		context.fill();

		for (var i = 0; i < 30; i++) {
			context.beginPath();
			context.moveTo(center,center);
			context.arc(center,center,center-20,i*2*Math.PI/30, (i+1)*2*Math.PI/30);
			context.lineTo(center,center);
			context.fillStyle =random_color();
			context.fill();

			context.save();
			context.translate(center, center);
			context.rotate(3*2*Math.PI/(5*30)+i*2*Math.PI/30);
			context.translate(-center, -center);
			context.font = "13px Comic Sans MS";
			context.textAlign = "right";
			context.fillStyle = "white";
			context.fillText("", canvas.width-30, center);
			context.restore();
		}

		let pos_ini=0;
		let clic=0;
		let movement;
		var  modificarNombreConcursantes;
		function sortear(){
			boton = document.getElementById('botonSortear');
			boton.style.display = 'none';
			eliminarGanadores(ganadoresEliminar);
			if (clic==0) {
				escogerGanadores()
				let canvas=document.getElementById("idcanvas");
				iniciarActualizacion();
				movement=setInterval(function(){
					pos_ini+=10;
					canvas.style.transform='rotate('+pos_ini+'deg)';
				},10);
				clic=1;
				document.getElementById("idestado").innerHTML="Detener";
			}else{
				clearInterval(movement);
				clearInterval(intervalID);
				clearTimeout(escogerGanadores);
				clic=0;
				document.getElementById("idestado").innerHTML="Sortear";
			}
		}

		function random_color(){
			let ar_digit=['2','3','4','5','6','7'];
			let color='';
			let i=0;
			while(i<6){
				let pos=Math.round(Math.random()*(ar_digit.length-1));
				color=color+''+ar_digit[pos];
				i++;
			}
			return '#'+color;
		}

	function actualizarH1ConTexto(winner = null) {
  var elementoH1 = document.querySelector("h1"); 
  if (elementoH1 && winner === null) {
    elementoH1.textContent = `Concursante: ${array_concursantes[indice].nombre}`; 
			indice = (indice + 1) % array_concursantes.length;
		} else {
			elementoH1.textContent = `Ganador: ${winner.nombre}`;
  }
}

function iniciarActualizacion() {
  intervalID = setInterval(actualizarH1ConTexto, 100);
}

	</script>
</body>
</html>